# iOSビルド配信用のワークフロー
#
# 他のワークフローから呼び出して実行する。
# パラメータとしてinputsとsecretsを受け取り、パラメータに応じてビルド・配信を実行する。
name: "Distribute iOS Build"

on:
  workflow_call:
    inputs:
      environment:
        description: "環境の名前：dev、またはprod"
        required: true
        type: string
      distribution_groups:
        description: "テスターのグループ名"
        required: true
        type: string
      release_notes:
        description: "配信のリリースノート"
        required: true
        type: string
      git_ref:
        description: "チェックアウトするgit ref（Optional。dev環境ではPRのブランチを指定している）"
        required: false
        type: string
        default: ""
    secrets:
      ENV_FILE:
        description: ".envファイルの内容（ビルドフレーバーごとの環境変数）"
        required: true
      GOOGLE_SERVICES_INFO:
        description: "base64エンコードされたGoogleService-Info.plist"
        required: true
      FIREBASE_SERVICE_CREDENTIAL:
        description: "base64エンコードされたFirebase App Distributionの秘密鍵（サービスアカウントから発行）"
        required: true
      APP_STORE_CONNECT_DISTRIBUTION_AUTH_KEY:
        description: "base64エンコードされたApp Store Connect APIのキー"
        required: true
      APP_STORE_CONNECT_KEY_ID:
        description: "App Store Connect APIのキーID"
        required: true
      APP_STORE_CONNECT_ISSUER_ID:
        description: "App Store Connect APIキーのIssuer ID"
        required: true
      APP_STORE_CONNECT_TEAM_ID:
        description: "App Developer ConsoleのチームID"
        required: true

jobs:
  distribute:
    # iOS版の配信のため、macOSを使用する。
    runs-on: "macos-latest"
    env:
      # App Distributionで配信対象とするテスターグループ
      FIREBASE_APP_DISTRIBUTION_GROUPS: ${{ inputs.distribution_groups }}
    steps:
      - uses: "actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493"
        with:
          # git_refが指定されている場合は指定されたgit_refを使用、なければcheckoutしているref。
          # 例えば、PRに対するコメントをトリガーにworkflow dispatchする場合等にgit_refを指定する。
          ref: ${{ inputs.git_ref != '' && inputs.git_ref || github.ref }}

      # 特定のXcodeのバージョンを指定する。
      # バージョンはリポジトリのvariablesで管理している。
      - name: "use specific Xcode version"
        run: |
          sudo xcode-select --switch /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      # 環境別の.envファイルを配置する。
      # 環境がdevならdev.env、prodならprod.envを配置する。
      - name: "setup .env"
        run: |
          echo "${{ secrets.ENV_FILE }}" > ./env/${{ inputs.environment }}.env

      # .envファイルからFirebase App IDを取得し、環境変数に設定する。
      - name: "setup Firebase App ID"
        run: |
          FIREBASE_IOS_APP_ID=$(grep '^firebaseAppId=' ./env/${{ inputs.environment }}.env | cut -d '=' -f2- | sed "s/^'//;s/'$//")
          echo "FIREBASE_IOS_APP_ID=${FIREBASE_IOS_APP_ID}" >> $GITHUB_ENV

      # .envファイルからアプリ名を取得し、環境変数に設定する。
      - name: "setup app name"
        run: |
          APP_NAME=$(grep '^appName=' ./env/${{ inputs.environment }}.env | cut -d '=' -f2- | sed "s/^'//;s/'$//")
          echo "APP_NAME=${APP_NAME}" >> $GITHUB_ENV

      # Firebase App Distributionの秘密鍵を配置する。
      # base64エンコードしてsecretsに置いているので、デコードしてファイルとして配置する。
      - name: "setup Firebase App Distribution credential"
        run: |
          mkdir -p private_keys
          echo -n "${{ secrets.FIREBASE_SERVICE_CREDENTIAL }}" | base64 --decode > $GITHUB_WORKSPACE/private_keys/firebase_app_distribution_key.json
          echo "FIREBASE_APP_DISTRIBUTION_KEY_PATH=$GITHUB_WORKSPACE/private_keys/firebase_app_distribution_key.json" >> $GITHUB_ENV

      # Firebase設定ファイル（GoogleService-Info.plist）を配置する。
      # base64エンコードしてsecretsに置いているので、デコードしてファイルとして配置する。
      - name: "setup GoogleService-Info.plist"
        run: |
          echo -n "${{ secrets.GOOGLE_SERVICES_INFO }}" | base64 --decode > ./ios/Runner/GoogleService-Info.plist

      # Flutterプロジェクトをセットアップする。
      - name: "setup flutter project"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          cache: true

      - name: "install dependencies"
        run: flutter pub get

      # CocoaPodsの依存関係をキャッシュする。
      # Podfile.lockをキーとして、依存関係のダウンロードとインストール時間を短縮する。
      - name: "cache CocoaPods dependencies"
        uses: "actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830"
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: ${{ runner.os }}-flutter-ios-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-ios-

      # App Store ConnectのAPIキーを配置する。
      # base64エンコードしてsecretsに置いているので、デコードしてファイルとして配置する。
      - name: "setup App Store Connect API Key"
        run: |
          echo -n "${{ secrets.APP_STORE_CONNECT_DISTRIBUTION_AUTH_KEY }}" | base64 --decode > private_keys/AuthKey.p8
          echo "API_KEY_PATH=${GITHUB_WORKSPACE}/private_keys/AuthKey.p8" >> $GITHUB_ENV

      # ExportOptions.plistを生成する。
      # AdHocExportOptions.plistをテンプレートとして、Team IDを埋め込んだExportOptions.plistを生成する。
      # このファイルはxcodebuild -exportArchiveで使用される。
      - name: "setup ExportOptions.plist with Team ID"
        run: |
          export APP_STORE_CONNECT_TEAM_ID="${{ secrets.APP_STORE_CONNECT_TEAM_ID }}"
          envsubst < ./ios/export_options/AdHocExportOptions.plist > ./ios/export_options/ExportOptions.plist

      # flutterコマンドでビルドを実行する。
      # コード署名なしでiOSアプリをビルドし、GitHub Run Numberを元に決めた整数値をビルド番号として使用する。
      # Firebase App Distributionはビルド番号を用いて配信されるアプリを区別する。
      # そのため、ビルドごとにユニークなビルド番号とするための処理である。
      - name: "build iOS app with Flutter"
        run: |
          flutter build ios --release --dart-define-from-file=env/${{ inputs.environment }}.env --no-codesign --build-number=$((100 + ${{ github.run_number }}))

      # Xcodeアーカイブを作成する。
      # コード署名なしでアーカイブファイル（.xcarchive）を生成する。
      - name: "create Xcode archive"
        run: |
          xcodebuild archive \
            -workspace ./ios/Runner.xcworkspace \
            -scheme Runner \
            -archivePath ./build/ios/archive/Runner.xcarchive \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      # クラウド署名でIPAをエクスポートする。
      # App Store Connect APIキーを使用して、アーカイブに署名しIPAファイルを生成する。
      - name: "export signed IPA"
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/ios/archive/Runner.xcarchive \
            -exportPath ./build/ios/ipa \
            -exportOptionsPlist ./ios/export_options/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyID "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" \
            -authenticationKeyPath "${API_KEY_PATH}"

      # 生成されたIPAファイルのパスを環境変数に設定する。
      # Firebase App Distributionが絶対パスを要求するため、絶対パスに変換する。
      - name: "set IPA path"
        run: |
          IPA_FILE=$(find ./build/ios/ipa -name "*.ipa" -type f | head -n 1)
          echo "IPA_PATH=${GITHUB_WORKSPACE}/${IPA_FILE}" >> $GITHUB_ENV

      # Firebase CLI をインストール
      - name: "install Firebase CLI"
        run: npm install -g firebase-tools

      # Firebase App Distribution にアップロード
      - name: "upload ipa to Firebase App Distribution"
        run: |
          firebase appdistribution:distribute "${IPA_PATH}" \
            --app "${FIREBASE_IOS_APP_ID}" \
            --groups "${FIREBASE_APP_DISTRIBUTION_GROUPS}" \
            --release-notes "${{ inputs.release_notes }}" \
            --service-account "${FIREBASE_APP_DISTRIBUTION_KEY_PATH}"